"use strict";var getParameterByName,fillRestaurantHTML,fillBreadcrumb,fillRestaurantHoursHTML,fillReviewsHTML,createReviewHTML,addReview,submitReview,starClick,orderByDate,restaurant=void 0;window.initMap=function(){var e=getParameterByName("id");e?DBHelper.fetchRestaurantById(e).then(function(e){self.restaurant=e,fillRestaurantHTML(),self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:e.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map)}).catch(function(e){return console.error(e)}):console.error("No restaurant id in URL")},fillRestaurantHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;var t=document.getElementById("restaurant-picture");t.className="restaurant-picture";var n=document.createElement("source");n.media="(min-width: 1024px)",n.sizes="100vw",n.srcset=DBHelper.imageUrlForRestaurant(e),t.append(n);var a=document.createElement("source");a.media="(min-width: 415px) and (max-width: 768px)",a.sizes="100vw",a.srcset=DBHelper.srcsetUrlMediumForRestaurant(e),t.append(a);var r=document.createElement("source");r.media="(max-width: 414px)",r.sizes="100vw",r.srcset=DBHelper.srcsetUrlSmallForRestaurant(e),t.append(r);var s=document.createElement("img");s.className="restaurant-img",s.alt=DBHelper.imageAltForRestaurants(e),s.src=DBHelper.imageUrlForRestaurant(e),t.append(s),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML();var i=document.getElementById("empty-heart"),l=document.getElementById("red-heart");i&&l&&("true"===self.restaurant.is_favorite?(l.classList.remove("invisible"),i.classList.add("invisible")):(l.classList.add("invisible"),i.classList.remove("invisible"))),i.addEventListener("click",function(){i.classList.add("invisible"),l.classList.remove("invisible"),DBHelper.favorRestaurant(self.restaurant.id)}),l.addEventListener("click",function(){l.classList.add("invisible"),i.classList.remove("invisible"),DBHelper.unfavorRestaurant(self.restaurant.id)})},fillRestaurantHoursHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e){var a=document.createElement("tr"),r=document.createElement("td");r.innerHTML=n,r.className="weekday",a.appendChild(r);var s=document.createElement("td");s.innerHTML=e[n],s.className="time",a.appendChild(s),t.appendChild(a)}},orderByDate=function(n,a){return n.slice().sort(function(e,t){return n[a]<t[a]?-1:1})},fillReviewsHTML=function(){var n=document.getElementById("reviews-container"),a=[],r=document.getElementById("reviews-list");r.innerHTML="",DBHelper.fetchRestaurantReviews(self.restaurant.id).then(function(e){if(!(a=self.orderByDate(e,"createdAt"))){document.body.classList.add("full-height");var t=document.createElement("p");return t.innerHTML="No reviews yet!",void n.appendChild(t)}a.forEach(function(e){r.appendChild(createReviewHTML(e))}),n.appendChild(r)}).catch(function(e){return console.error(e)})},createReviewHTML=function(e){var t=document.createElement("li"),n=document.createElement("p");n.className="review-name",n.innerHTML=e.name,t.appendChild(n);var a=document.createElement("p"),r=new Date(e.updatedAt).toDateString().split(" ");a.innerHTML=r[1]+" "+r[2]+", "+r[3],a.className="review-date",t.appendChild(a);var s=document.createElement("p");if(s.innerHTML="Rating: "+e.rating,s.className="review-rating",t.appendChild(s),e.comments){var i=document.createElement("p");i.innerHTML=e.comments,t.appendChild(i)}return t},fillBreadcrumb=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)},getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},submitReview=function(){for(var e=1;e<=5;e++)document.getElementById("empty-star-"+e).classList.remove("invisible"),document.getElementById("full-star-"+e).classList.add("invisible")};var username=document.getElementById("username"),userrating=document.getElementById("userrating"),form=document.getElementById("form");form.addEventListener("change",function(){username.value&&userrating.value&&(form.elements[3].disabled=!1)}),starClick=function(e){var t=e.split("-")[0],n=e.split("-")[2];switch(t){case"empty":userrating.value=parseInt(n);for(var a=1;a<=parseInt(n);a++)document.getElementById("empty-star-"+a).classList.add("invisible"),document.getElementById("full-star-"+a).classList.remove("invisible");username.value&&(form.elements[3].disabled=!1);break;case"full":1<userrating.value?userrating.value=parseInt(n)-1:userrating.value=null;for(var r=parseInt(n)+1;r<=5;r++)document.getElementById("empty-star-"+r).classList.remove("invisible"),document.getElementById("full-star-"+r).classList.add("invisible");username.value&&(form.elements[3].disabled=!1)}};var button=document.getElementById("formhandler"),dismissButton=document.getElementById("dismiss-button"),successMessage=document.getElementById("review-success"),offlineMessage=document.getElementById("review-offline");button.addEventListener("click",function(e){var t=new FormData;if(t.append("restaurant_id",self.restaurant.id),t.append("name",form.name.value),t.append("rating",parseInt(form.rating.value)),t.append("createdAt",Date.now()),form.comments.value&&t.append("comments",form.comments.value),!navigator.onLine){var n={restaurant_id:self.restaurant.id,name:form.name.value,rating:parseInt(form.rating.value),comments:form.comments.value,createdAt:Date.now()};return DBHelper.openDB().then(function(e){var t=e.transaction("outbox","readwrite");return t.objectStore("outbox").put(n),t.complete}).then(function(){form.reset(),console.log("Review has been stored in the IndexedDB."),offlineMessage.classList.remove("invisible"),setTimeout(function(){offlineMessage.classList.add("invisible")},3e3)}).catch(function(e){throw console.log("Something went wrong with the database."),console.error(e),e})}DBHelper.addRestaurantReview(t).then(function(){form.reset(),self.fillReviewsHTML(),successMessage.classList.remove("invisible"),console.log("Review has been published."),setTimeout(function(){successMessage.classList.add("invisible")},3e3)})}),dismissButton.addEventListener("click",function(e){form.reset()}),document.addEventListener("online",function(e){return console.log("online again!"),DBHelper.openDB().then(function(e){return e.transaction("outbox","readonly").objectStore("outbox").getAll()}).then(function(e){if(e&&0<e.length)return Promise.all(e.map(function(t){var e=new FormData;return e.append("restaurant_id",t.restaurant_id),e.append("name",t.name),e.append("rating",t.rating),e.append("createdAt",t.createdAt),t.comments&&e.append("comments",t.comments),fetch(DBHelper.REVIEWS_URL+"/",{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){if(e)return DBHelper.openDB().then(function(e){return e.transaction("outbox","readwrite").objectStore("outbox").delete(t.id)})}).catch(function(e){throw console.error(e),e}).then(function(){self.fillReviewsHTML(),successMessage.classList.remove("invisible"),setTimeout(function(){successMessage.classList.add("invisible")},3e3),console.log("Review has been sent to the server and removed from the IndexedDB.")})}))})});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlc3RhdXJhbnRfaW5mby5qcyJdLCJuYW1lcyI6WyJnZXRQYXJhbWV0ZXJCeU5hbWUiLCJmaWxsUmVzdGF1cmFudEhUTUwiLCJmaWxsQnJlYWRjcnVtYiIsImZpbGxSZXN0YXVyYW50SG91cnNIVE1MIiwiZmlsbFJldmlld3NIVE1MIiwiY3JlYXRlUmV2aWV3SFRNTCIsImFkZFJldmlldyIsInN1Ym1pdFJldmlldyIsInJlc3RhdXJhbnQiLCJ3aW5kb3ciLCJpbml0TWFwIiwiaWQiLCJEQkhlbHBlciIsImZldGNoUmVzdGF1cmFudEJ5SWQiLCJ0aGVuIiwic2VsZiIsIm1hcCIsImdvb2dsZSIsIm1hcHMiLCJNYXAiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiem9vbSIsImxhdGxuZyIsImNlbnRlciIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwibmFtZSIsInBpY3R1cmUiLCJhZGRyZXNzIiwibGFyZ2VTb3VyY2UiLCJjcmVhdGVFbGVtZW50IiwiY2xhc3NOYW1lIiwic3Jjc2V0IiwiaW1hZ2VVcmxGb3JSZXN0YXVyYW50IiwiYXBwZW5kIiwibWVkaXVtU291cmNlIiwic3Jjc2V0VXJsTWVkaXVtRm9yUmVzdGF1cmFudCIsInNtYWxsU291cmNlIiwic3Jjc2V0VXJsU21hbGxGb3JSZXN0YXVyYW50Iiwic2l6ZXMiLCJpbWFnZSIsInNyYyIsImltYWdlQWx0Rm9yUmVzdGF1cmFudHMiLCJjdWlzaW5lIiwiZW1wdHlIZWFydCIsInJlZEhlYXJ0IiwiaXNfZmF2b3JpdGUiLCJjbGFzc0xpc3QiLCJhZGQiLCJyZW1vdmUiLCJhZGRFdmVudExpc3RlbmVyIiwib3BlcmF0aW5nSG91cnMiLCJvcGVyYXRpbmdfaG91cnMiLCJrZXkiLCJob3VycyIsInJvdyIsImRheSIsImlubmVySFRNTCIsImFwcGVuZENoaWxkIiwidGltZSIsIm9yZGVyQnlEYXRlIiwiYXJyIiwiZGF0ZVByb3AiLCJzbGljZSIsInNvcnQiLCJhIiwiYiIsImNvbnRhaW5lciIsInVsIiwiZGF0YSIsInJldmlld3MiLCJmZXRjaFJlc3RhdXJhbnRSZXZpZXdzIiwiYm9keSIsIm5vUmV2aWV3cyIsImZvckVhY2giLCJyZXZpZXciLCJsaSIsInVwZGF0ZWQiLCJEYXRlIiwidXBkYXRlZEF0IiwidG9EYXRlU3RyaW5nIiwic3BsaXQiLCJkYXRlIiwicmF0aW5nIiwiY29tbWVudHMiLCJicmVhZGNydW1iIiwidXJsIiwibG9jYXRpb24iLCJocmVmIiwicmVwbGFjZSIsIlJlZ0V4cCIsInJlZ2V4IiwicmVzdWx0cyIsImkiLCJ1c2VybmFtZSIsInVzZXJyYXRpbmciLCJmb3JtIiwic3RhckNsaWNrIiwic3RhdHVzIiwicGFyc2VJbnQiLCJ2YWx1ZSIsImRpc2FibGVkIiwiZWxlbWVudHMiLCJidXR0b24iLCJkaXNtaXNzQnV0dG9uIiwic3VjY2Vzc01lc3NhZ2UiLCJvZmZsaW5lTWVzc2FnZSIsImV2ZW50IiwiZm9ybURhdGEiLCJGb3JtRGF0YSIsIm5vdyIsIm5hdmlnYXRvciIsIm9uTGluZSIsInJlc3RhdXJhbnRfaWQiLCJjcmVhdGVkQXQiLCJvcGVuREIiLCJ0eCIsInN0b3JlIiwib2JqZWN0U3RvcmUiLCJwdXQiLCJjb21wbGV0ZSIsInNldFRpbWVvdXQiLCJsb2ciLCJhZGRSZXN0YXVyYW50UmV2aWV3IiwicmVzZXQiLCJlIiwiZGIiLCJ0cmFuc2FjdGlvbiIsImdldEFsbCIsImFsbCIsIm1ldGhvZCIsIlJFVklFV1NfVVJMIiwicmVzcG9uc2UiLCJqc29uIl0sIm1hcHBpbmdzIjoiYUFDQSxJQUlBQSxtQkFHSUMsbUJBREFELGVBQ0FDLHdCQUNBQyxnQkFDQUMsaUJBQ0FDLFVBQ0FDLGFBQ0FDLFVBQ0FDLFlBYkFDLGdCQUFBQSxFQW9CSkMsT0FBT0MsUUFBVSxXQUFqQkQsSUFBT0MsRUFBQUEsbUJBQWdCLE1BR2hCQyxFQUdIQyxTQUFBQyxvQkFBQUYsR0FIRkcsS0FJTyxTQUFBTixHQUNMSSxLQUFTQyxXQUFB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UFZVLFdBVVBwQixLQUFBQSxTQUFBQSxHQUNBQSxHQUFBQSxHQUEwQmpDLEVBQWpCekMsRUFBT1YsT0FDaEJvRixPQUFBQSxRQUFBcUIsSUFQRjNELEVBQVE1RCxJQUFJLFNBQUFpRSxHQVVSaUMsSUFBQUEsRUFBZ0IsSUFBQUMsU0FZVixPQVZSRCxFQUFnQnRHLE9BQUFBLGdCQUFUcUUsRUFBa0NzQyxlQUN2Q2lCLEVBQVFoRyxPQUQrQixPQUFBeUMsRUFBQWpELE1BRXZDOEMsRUFBTW9DLE9BQUFBLFNBQUFBLEVBQUFBLFFBQ0xwRyxFQUFLMEIsT0FBQSxZQUFZeUMsRUFBQXVDLFdBR2R2QyxFQUFBUyxVQUNBZixFQUFNbkMsT0FBQSxXQUFBeUMsRUFBQVMsVUFHRWdDLE1BQVFXLFNBQUhJLFlBQUxmLElBQThCLENBQ3BDYyxPQUFNYixPQUNON0MsS0FBQW9DLElBSkpwRyxLQUFBLFNBQUE0SCxHQU1DLE9BQUFBLEVBQUFDLFNBRUhoSCxLQUFRQyxTQUFBQSxHQUNSLEdBQU1GLEVBQ0EsT0FBQWQsU0FBTTZHLFNBQ1BySCxLQUFBQSxTQUFBQSxHQUdIMkcsT0FGYTFELEVBQWZnRixZQUFnQyxTQUFoQyxhQUNpQlQsWUFBQSxVQUNBdkUsT0FBZjRCLEVBQTZCdEUsUUF0QmpDYyxNQUFBLFNBQUFDLEdBNEJMLE1BekNDQyxRQUFBQyxNQUFBRixHQXlDREEsSUFqRExaLEtBQUEsV0FGRkMsS0FBQVgsa0JBMkNjMkcsZUFBZTFELFVBQVVFLE9BQU8sYUFDaEN3RSxXQUFXLFdBQ1RoQixlQUFlMUQsVUFBVUMsSUFBSSxjQUM1QixLQUNIM0IsUUFBUXFHLElBQUkiLCJmaWxlIjoicmVzdGF1cmFudF9pbmZvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyplc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyovXHJcbmxldCByZXN0YXVyYW50O1xyXG4vKmVzbGludCBsaW5lYnJlYWstc3R5bGU6IFtcImVycm9yXCIsIFwid2luZG93c1wiXSovXHJcbi8qZ2xvYmFsIERCSGVscGVyICovXHJcbi8qZ2xvYmFsIGdvb2dsZSAqL1xyXG4vKmdsb2JhbCBpZGIgKi9cclxuXHJcbnZhciBnZXRQYXJhbWV0ZXJCeU5hbWU7XHJcbnZhciBmaWxsUmVzdGF1cmFudEhUTUw7XHJcbnZhciBmaWxsQnJlYWRjcnVtYjtcclxudmFyIGZpbGxSZXN0YXVyYW50SG91cnNIVE1MO1xyXG52YXIgZmlsbFJldmlld3NIVE1MO1xyXG52YXIgY3JlYXRlUmV2aWV3SFRNTDtcclxudmFyIGFkZFJldmlldztcclxudmFyIHN1Ym1pdFJldmlldztcclxudmFyIHN0YXJDbGljaztcclxudmFyIG9yZGVyQnlEYXRlO1xyXG5cclxuLyoqXHJcbiAqIEluaXRpYWxpemUgR29vZ2xlIG1hcCwgY2FsbGVkIGZyb20gSFRNTC5cclxuICovXHJcbndpbmRvdy5pbml0TWFwID0gKCkgPT4ge1xyXG5cclxuICBjb25zdCBpZCA9IGdldFBhcmFtZXRlckJ5TmFtZSgnaWQnKTtcclxuICBpZiAoIWlkKSB7XHJcbiAgICAvLyBubyBpZCBmb3VuZCBpbiBVUkxcclxuICAgIGNvbnNvbGUuZXJyb3IoJ05vIHJlc3RhdXJhbnQgaWQgaW4gVVJMJyk7XHJcbiAgICByZXR1cm47XHJcbiAgfSBlbHNlIHtcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudEJ5SWQoaWQpXHJcbiAgICAgIC50aGVuKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgICAgIHNlbGYucmVzdGF1cmFudCA9IHJlc3RhdXJhbnQ7XHJcblxyXG4gICAgICAgIGZpbGxSZXN0YXVyYW50SFRNTCgpO1xyXG5cclxuICAgICAgICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XHJcbiAgICAgICAgICB6b29tOiAxNixcclxuICAgICAgICAgIGNlbnRlcjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgICAgICBzY3JvbGx3aGVlbDogZmFsc2VcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZmlsbEJyZWFkY3J1bWIoKTtcclxuICAgICAgICBEQkhlbHBlci5tYXBNYXJrZXJGb3JSZXN0YXVyYW50KHNlbGYucmVzdGF1cmFudCwgc2VsZi5tYXApO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZXJyID0+IGNvbnNvbGUuZXJyb3IoZXJyKSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwgYW5kIGFkZCBpdCB0byB0aGUgd2VicGFnZVxyXG4gKi9cclxuXHJcbmZpbGxSZXN0YXVyYW50SFRNTCA9IChyZXN0YXVyYW50ID0gc2VsZi5yZXN0YXVyYW50KSA9PiB7XHJcbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LW5hbWUnKTtcclxuICBuYW1lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuXHJcbiAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWFkZHJlc3MnKTtcclxuICBhZGRyZXNzLmlubmVySFRNTCA9IHJlc3RhdXJhbnQuYWRkcmVzcztcclxuXHJcbiAgY29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LXBpY3R1cmUnKTtcclxuICBwaWN0dXJlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LXBpY3R1cmUnO1xyXG5cclxuICBjb25zdCBsYXJnZVNvdXJjZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xyXG4gIGxhcmdlU291cmNlLm1lZGlhID0gJyhtaW4td2lkdGg6IDEwMjRweCknO1xyXG4gIGxhcmdlU291cmNlLnNpemVzID0gJzEwMHZ3JztcclxuICBsYXJnZVNvdXJjZS5zcmNzZXQgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgcGljdHVyZS5hcHBlbmQobGFyZ2VTb3VyY2UpO1xyXG5cclxuICBjb25zdCBtZWRpdW1Tb3VyY2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcclxuICBtZWRpdW1Tb3VyY2UubWVkaWEgPSAnKG1pbi13aWR0aDogNDE1cHgpIGFuZCAobWF4LXdpZHRoOiA3NjhweCknO1xyXG4gIG1lZGl1bVNvdXJjZS5zaXplcyA9ICcxMDB2dyc7XHJcbiAgbWVkaXVtU291cmNlLnNyY3NldCA9IERCSGVscGVyLnNyY3NldFVybE1lZGl1bUZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgcGljdHVyZS5hcHBlbmQobWVkaXVtU291cmNlKTtcclxuXHJcbiAgY29uc3Qgc21hbGxTb3VyY2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcclxuICBzbWFsbFNvdXJjZS5tZWRpYSA9ICcobWF4LXdpZHRoOiA0MTRweCknO1xyXG4gIHNtYWxsU291cmNlLnNpemVzID0gJzEwMHZ3JztcclxuICBzbWFsbFNvdXJjZS5zcmNzZXQgPSBEQkhlbHBlci5zcmNzZXRVcmxTbWFsbEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgcGljdHVyZS5hcHBlbmQoc21hbGxTb3VyY2UpO1xyXG5cclxuICBjb25zdCBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG4gIGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyc7XHJcbiAgaW1hZ2UuYWx0ID0gREJIZWxwZXIuaW1hZ2VBbHRGb3JSZXN0YXVyYW50cyhyZXN0YXVyYW50KTtcclxuICBpbWFnZS5zcmMgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgcGljdHVyZS5hcHBlbmQoaW1hZ2UpO1xyXG5cclxuICBjb25zdCBjdWlzaW5lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtY3Vpc2luZScpO1xyXG4gIGN1aXNpbmUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5jdWlzaW5lX3R5cGU7XHJcblxyXG4gIC8vIGZpbGwgb3BlcmF0aW5nIGhvdXJzXHJcbiAgaWYgKHJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzKSB7XHJcbiAgICBmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCgpO1xyXG4gIH1cclxuICAvLyBmaWxsIHJldmlld3NcclxuICBmaWxsUmV2aWV3c0hUTUwoKTtcclxuXHJcbiAgXHJcbiAgY29uc3QgZW1wdHlIZWFydCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbXB0eS1oZWFydCcpO1xyXG4gIGNvbnN0IHJlZEhlYXJ0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZC1oZWFydCcpO1xyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogV2UgYXJlIHNob3dpbmcgdGhlIHByb3BlciBoZWFydCBpY29uIGJhc2VkIG9uIGlzX2Zhdm9yYWJsZSBwcm9wZXJ0eSBvZiB0aGUgcmVzdGF1cmFudFxyXG4gICAqL1xyXG4gIGlmIChlbXB0eUhlYXJ0ICYmIHJlZEhlYXJ0KSB7XHJcbiAgICBpZiAoc2VsZi5yZXN0YXVyYW50LmlzX2Zhdm9yaXRlID09PSAndHJ1ZScpIHtcclxuICAgICAgcmVkSGVhcnQuY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7XHJcbiAgICAgIGVtcHR5SGVhcnQuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZWRIZWFydC5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTtcclxuICAgICAgZW1wdHlIZWFydC5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRvZ2dsZSBjbGFzcyAuaW52aXNpYmxlIGFzIHVzZXIgY2xpY2tzIG9uIGhlYXJ0cyBpY29ucyB0byBmYXZvdXIgLyB1bmZhdm91ciB0aGUgcmVzdGF1cmFudCxcclxuICAgKiB0aGVuIGNoYW5nZSB0aGUgc3RhdHVzIG9mIHRoZSByZXN0YXVyYW50IGluIHRoZSBiYWNrZW5kIGJ5IHBvc3RpbmcgYSByZXF1ZXN0IHRvIHRoZSBwcm9wZXIgQVBJXHJcbiAgICovXHJcblxyXG4gIGVtcHR5SGVhcnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHtcclxuICAgIGVtcHR5SGVhcnQuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7XHJcbiAgICByZWRIZWFydC5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgIERCSGVscGVyLmZhdm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQuaWQpO1xyXG4gIH0pO1xyXG5cclxuICByZWRIZWFydC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkge1xyXG4gICAgcmVkSGVhcnQuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7XHJcbiAgICBlbXB0eUhlYXJ0LmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpO1xyXG4gICAgREJIZWxwZXIudW5mYXZvclJlc3RhdXJhbnQoc2VsZi5yZXN0YXVyYW50LmlkKTtcclxuICB9KTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBDcmVhdGUgcmVzdGF1cmFudCBvcGVyYXRpbmcgaG91cnMgSFRNTCB0YWJsZSBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxyXG4gKi9cclxuZmlsbFJlc3RhdXJhbnRIb3Vyc0hUTUwgPSAoXHJcbiAgb3BlcmF0aW5nSG91cnMgPSBzZWxmLnJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzXHJcbikgPT4ge1xyXG4gIGNvbnN0IGhvdXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtaG91cnMnKTtcclxuICBmb3IgKGxldCBrZXkgaW4gb3BlcmF0aW5nSG91cnMpIHtcclxuICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7XHJcblxyXG4gICAgY29uc3QgZGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcclxuICAgIGRheS5pbm5lckhUTUwgPSBrZXk7XHJcbiAgICBkYXkuY2xhc3NOYW1lID0gJ3dlZWtkYXknO1xyXG4gICAgcm93LmFwcGVuZENoaWxkKGRheSk7XHJcblxyXG4gICAgY29uc3QgdGltZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XHJcbiAgICB0aW1lLmlubmVySFRNTCA9IG9wZXJhdGluZ0hvdXJzW2tleV07XHJcbiAgICB0aW1lLmNsYXNzTmFtZSA9ICd0aW1lJztcclxuICAgIHJvdy5hcHBlbmRDaGlsZCh0aW1lKTtcclxuXHJcbiAgICBob3Vycy5hcHBlbmRDaGlsZChyb3cpO1xyXG4gIH1cclxufTtcclxuXHJcbm9yZGVyQnlEYXRlID0gKGFyciwgZGF0ZVByb3ApID0+IHtcclxuICByZXR1cm4gYXJyLnNsaWNlKCkuc29ydChmdW5jdGlvbihhLCBiKSB7XHJcbiAgICByZXR1cm4gYXJyW2RhdGVQcm9wXSA8IGJbZGF0ZVByb3BdID8gLTEgOiAxO1xyXG4gIH0pO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmV2aWV3cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZpbGxSZXZpZXdzSFRNTCA9ICgpID0+IHtcclxuICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1jb250YWluZXInKTtcclxuICBsZXQgcmV2aWV3cyA9IFtdO1xyXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtbGlzdCcpO1xyXG4gIHVsLmlubmVySFRNTCA9ICcnO1xyXG5cclxuICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRSZXZpZXdzKHNlbGYucmVzdGF1cmFudC5pZClcclxuICAgIC50aGVuKGRhdGEgPT4ge1xyXG4gICAgICByZXZpZXdzID0gc2VsZi5vcmRlckJ5RGF0ZShkYXRhLCAnY3JlYXRlZEF0Jyk7XHJcbiAgICAgIGlmICghcmV2aWV3cykge1xyXG4gICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5ib2R5O1xyXG4gICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgnZnVsbC1oZWlnaHQnKTtcclxuICAgICAgICBjb25zdCBub1Jldmlld3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgbm9SZXZpZXdzLmlubmVySFRNTCA9ICdObyByZXZpZXdzIHlldCEnO1xyXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChub1Jldmlld3MpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV2aWV3cy5mb3JFYWNoKHJldmlldyA9PiB7XHJcbiAgICAgICAgdWwuYXBwZW5kQ2hpbGQoY3JlYXRlUmV2aWV3SFRNTChyZXZpZXcpKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh1bCk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGVyciA9PiBjb25zb2xlLmVycm9yKGVycikpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXZpZXcgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxyXG4gKi9cclxuY3JlYXRlUmV2aWV3SFRNTCA9IHJldmlldyA9PiB7XHJcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xyXG4gIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgbmFtZS5jbGFzc05hbWUgPSAncmV2aWV3LW5hbWUnO1xyXG4gIG5hbWUuaW5uZXJIVE1MID0gcmV2aWV3Lm5hbWU7XHJcbiAgbGkuYXBwZW5kQ2hpbGQobmFtZSk7XHJcblxyXG4gIGNvbnN0IGRhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgY29uc3QgdXBkYXRlZCA9IG5ldyBEYXRlKHJldmlldy51cGRhdGVkQXQpLnRvRGF0ZVN0cmluZygpLnNwbGl0KCcgJyk7XHJcbiAgZGF0ZS5pbm5lckhUTUwgPSB1cGRhdGVkWzFdICsgJyAnICsgdXBkYXRlZFsyXSArICcsICcgKyB1cGRhdGVkWzNdO1xyXG4gIGRhdGUuY2xhc3NOYW1lID0gJ3Jldmlldy1kYXRlJztcclxuICBsaS5hcHBlbmRDaGlsZChkYXRlKTtcclxuXHJcbiAgY29uc3QgcmF0aW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gIHJhdGluZy5pbm5lckhUTUwgPSBgUmF0aW5nOiAke3Jldmlldy5yYXRpbmd9YDtcclxuICByYXRpbmcuY2xhc3NOYW1lID0gJ3Jldmlldy1yYXRpbmcnO1xyXG4gIGxpLmFwcGVuZENoaWxkKHJhdGluZyk7XHJcblxyXG4gIGlmIChyZXZpZXcuY29tbWVudHMpIHtcclxuICAgIGNvbnN0IGNvbW1lbnRzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgY29tbWVudHMuaW5uZXJIVE1MID0gcmV2aWV3LmNvbW1lbnRzO1xyXG4gICAgbGkuYXBwZW5kQ2hpbGQoY29tbWVudHMpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGxpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEFkZCByZXN0YXVyYW50IG5hbWUgdG8gdGhlIGJyZWFkY3J1bWIgbmF2aWdhdGlvbiBtZW51XHJcbiAqL1xyXG5maWxsQnJlYWRjcnVtYiA9IChyZXN0YXVyYW50ID0gc2VsZi5yZXN0YXVyYW50KSA9PiB7XHJcbiAgY29uc3QgYnJlYWRjcnVtYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdicmVhZGNydW1iJyk7XHJcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xyXG4gIGxpLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICBicmVhZGNydW1iLmFwcGVuZENoaWxkKGxpKTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBHZXQgYSBwYXJhbWV0ZXIgYnkgbmFtZSBmcm9tIHBhZ2UgVVJMLlxyXG4gKi9cclxuZ2V0UGFyYW1ldGVyQnlOYW1lID0gKG5hbWUsIHVybCkgPT4ge1xyXG4gIGlmICghdXJsKSB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjtcclxuICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bW1xcXV0vZywgJ1xcXFwkJicpO1xyXG4gIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChgWz8mXSR7bmFtZX0oPShbXiYjXSopfCZ8I3wkKWApLFxyXG4gICAgcmVzdWx0cyA9IHJlZ2V4LmV4ZWModXJsKTtcclxuICBpZiAoIXJlc3VsdHMpIHJldHVybiBudWxsO1xyXG4gIGlmICghcmVzdWx0c1syXSkgcmV0dXJuICcnO1xyXG4gIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1syXS5yZXBsYWNlKC9cXCsvZywgJyAnKSk7XHJcbn07XHJcblxyXG4vKipcclxuICogQ2xlYXIgc3RhciByYXRpbmdzIGFuZCBjbG9zZSBtb2RhbCBvbiBmb3JtIHN1Ym1pdFxyXG4gKi9cclxuc3VibWl0UmV2aWV3ID0gKCkgPT4ge1xyXG4gIGZvciAobGV0IGkgPSAxOyBpIDw9IDU7IGkrKykge1xyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGVtcHR5LXN0YXItJHtpfWApLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpO1xyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGZ1bGwtc3Rhci0ke2l9YCkuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEZvcm0gdmFsaWRhdGlvbiBmdW5jdGlvbnMgZ28gaGVyZVxyXG4gKi9cclxuY29uc3QgdXNlcm5hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXNlcm5hbWUnKTtcclxuY29uc3QgdXNlcnJhdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VycmF0aW5nJyk7XHJcbmNvbnN0IGZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybScpO1xyXG5cclxuZm9ybS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICBpZiAodXNlcm5hbWUudmFsdWUgJiYgdXNlcnJhdGluZy52YWx1ZSkge1xyXG4gICAgZm9ybS5lbGVtZW50c1szXS5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gIH1cclxufSk7XHJcblxyXG4vKipcclxuICogU3RhciByYXRpbmcgaWNvbnMgdG9nZ2xlIGZ1bmN0aW9uXHJcbiAqL1xyXG5cclxuc3RhckNsaWNrID0gaWQgPT4ge1xyXG4gIGNvbnN0IHN0YXR1cyA9IGlkLnNwbGl0KCctJylbMF07XHJcbiAgY29uc3QgcmF0aW5nID0gaWQuc3BsaXQoJy0nKVsyXTtcclxuXHJcbiAgc3dpdGNoIChzdGF0dXMpIHtcclxuICAgIGNhc2UgJ2VtcHR5JzpcclxuICAgICAgdXNlcnJhdGluZy52YWx1ZSA9IHBhcnNlSW50KHJhdGluZyk7XHJcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHBhcnNlSW50KHJhdGluZyk7IGkrKykge1xyXG4gICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBlbXB0eS1zdGFyLSR7aX1gKS5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTtcclxuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgZnVsbC1zdGFyLSR7aX1gKS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodXNlcm5hbWUudmFsdWUpIHtcclxuICAgICAgICBmb3JtLmVsZW1lbnRzWzNdLmRpc2FibGVkID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdmdWxsJzpcclxuICAgICAgdXNlcnJhdGluZy52YWx1ZSA+IDFcclxuICAgICAgICA/ICh1c2VycmF0aW5nLnZhbHVlID0gcGFyc2VJbnQocmF0aW5nKSAtIDEpXHJcbiAgICAgICAgOiAodXNlcnJhdGluZy52YWx1ZSA9IG51bGwpO1xyXG4gICAgICBmb3IgKGxldCBpID0gcGFyc2VJbnQocmF0aW5nKSArIDE7IGkgPD0gNTsgaSsrKSB7XHJcbiAgICAgICAgZG9jdW1lbnRcclxuICAgICAgICAgIC5nZXRFbGVtZW50QnlJZChgZW1wdHktc3Rhci0ke2l9YClcclxuICAgICAgICAgIC5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgZnVsbC1zdGFyLSR7aX1gKS5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodXNlcm5hbWUudmFsdWUpIHtcclxuICAgICAgICBmb3JtLmVsZW1lbnRzWzNdLmRpc2FibGVkID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgYnJlYWs7XHJcbiAgfVxyXG59O1xyXG5cclxuY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1oYW5kbGVyJyk7XHJcbmNvbnN0IGRpc21pc3NCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlzbWlzcy1idXR0b24nKTtcclxuY29uc3Qgc3VjY2Vzc01lc3NhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3LXN1Y2Nlc3MnKTtcclxuY29uc3Qgb2ZmbGluZU1lc3NhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3LW9mZmxpbmUnKTtcclxuXHJcbmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7XHJcblxyXG4gIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcblxyXG4gIGZvcm1EYXRhLmFwcGVuZCgncmVzdGF1cmFudF9pZCcsIHNlbGYucmVzdGF1cmFudC5pZCk7XHJcbiAgZm9ybURhdGEuYXBwZW5kKCduYW1lJywgZm9ybS5uYW1lLnZhbHVlKTtcclxuICBmb3JtRGF0YS5hcHBlbmQoJ3JhdGluZycsIHBhcnNlSW50KGZvcm0ucmF0aW5nLnZhbHVlKSk7XHJcbiAgZm9ybURhdGEuYXBwZW5kKCdjcmVhdGVkQXQnLCBEYXRlLm5vdygpKTtcclxuXHJcbiAgaWYgKGZvcm0uY29tbWVudHMudmFsdWUpIHtcclxuICAgIGZvcm1EYXRhLmFwcGVuZCgnY29tbWVudHMnLCBmb3JtLmNvbW1lbnRzLnZhbHVlKTtcclxuICB9XHJcblxyXG4gIGlmIChuYXZpZ2F0b3Iub25MaW5lKSB7XHJcbiAgICBEQkhlbHBlci5hZGRSZXN0YXVyYW50UmV2aWV3KGZvcm1EYXRhKS50aGVuKCgpID0+IHtcclxuICAgICAgZm9ybS5yZXNldCgpO1xyXG4gICAgICBzZWxmLmZpbGxSZXZpZXdzSFRNTCgpO1xyXG4gICAgICBzdWNjZXNzTWVzc2FnZS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgICAgY29uc29sZS5sb2coJ1JldmlldyBoYXMgYmVlbiBwdWJsaXNoZWQuJyk7XHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHN1Y2Nlc3NNZXNzYWdlLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpO1xyXG4gICAgICB9LCAzMDAwKTtcclxuICAgIH0pO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBsZXQgcmV2aWV3ID0ge1xyXG4gICAgICByZXN0YXVyYW50X2lkOiBzZWxmLnJlc3RhdXJhbnQuaWQsXHJcbiAgICAgIG5hbWU6IGZvcm0ubmFtZS52YWx1ZSxcclxuICAgICAgcmF0aW5nOiBwYXJzZUludChmb3JtLnJhdGluZy52YWx1ZSksXHJcbiAgICAgIGNvbW1lbnRzOiBmb3JtLmNvbW1lbnRzLnZhbHVlLFxyXG4gICAgICBjcmVhdGVkQXQ6IERhdGUubm93KClcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIERCSGVscGVyLm9wZW5EQigpXHJcbiAgICAudGhlbihkYiA9PiB7XHJcbiAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ291dGJveCcsICdyZWFkd3JpdGUnKTtcclxuICAgICAgY29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgnb3V0Ym94Jyk7XHJcbiAgICAgIHN0b3JlLnB1dChyZXZpZXcpO1xyXG4gICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICBmb3JtLnJlc2V0KCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZXZpZXcgaGFzIGJlZW4gc3RvcmVkIGluIHRoZSBJbmRleGVkREIuJyk7XHJcbiAgICAgIG9mZmxpbmVNZXNzYWdlLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpO1xyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBvZmZsaW5lTWVzc2FnZS5jbGFzc0xpc3QuYWRkKCdpbnZpc2libGUnKTtcclxuICAgICAgfSwgMzAwMCk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZyhcclxuICAgICAgICAnU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2l0aCB0aGUgZGF0YWJhc2UuJ1xyXG4gICAgICApO1xyXG4gICAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICAgIHRocm93IGVycjtcclxuICAgIH0pO1xyXG4gIH0gIFxyXG59KTtcclxuXHJcbmRpc21pc3NCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBldmVudCA9PiB7XHJcbiAgZm9ybS5yZXNldCgpO1xyXG59KTtcclxuXHJcbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ29ubGluZScsIGZ1bmN0aW9uKGUpIHtcclxuICBjb25zb2xlLmxvZygnb25saW5lIGFnYWluIScpO1xyXG4gIHJldHVybiBEQkhlbHBlci5vcGVuREIoKVxyXG4gICAgLnRoZW4oZGIgPT4ge1xyXG4gICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdvdXRib3gnLCAncmVhZG9ubHknKTtcclxuICAgICAgY29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgnb3V0Ym94JylcclxuICAgICAgcmV0dXJuIHN0b3JlLmdldEFsbCgpO1xyXG4gICAgfSlcclxuICAgIC50aGVuKHJldmlld3MgPT4ge1xyXG4gICAgICBpZiAocmV2aWV3cyAmJiByZXZpZXdzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgICByZXZpZXdzLm1hcChyZXZpZXcgPT4ge1xyXG4gIFxyXG4gICAgICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xyXG4gIFxyXG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3Jlc3RhdXJhbnRfaWQnLCByZXZpZXcucmVzdGF1cmFudF9pZCk7XHJcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnbmFtZScsIHJldmlldy5uYW1lKTtcclxuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdyYXRpbmcnLCByZXZpZXcucmF0aW5nKTtcclxuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdjcmVhdGVkQXQnLCByZXZpZXcuY3JlYXRlZEF0KTtcclxuICBcclxuICAgICAgICAgICAgaWYgKHJldmlldy5jb21tZW50cykge1xyXG4gICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnY29tbWVudHMnLCByZXZpZXcuY29tbWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmZXRjaChgJHtEQkhlbHBlci5SRVZJRVdTX1VSTH0vYCwge1xyXG4gICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxyXG4gICAgICAgICAgICAgIGJvZHk6IGZvcm1EYXRhXHJcbiAgICAgICAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gREJIZWxwZXIub3BlbkRCKClcclxuICAgICAgICAgICAgICAgICAgLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ291dGJveCcsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdvdXRib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RvcmUuZGVsZXRlKHJldmlldy5pZCk7XHJcbiAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgfSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgc2VsZi5maWxsUmV2aWV3c0hUTUwoKTtcclxuICAgICAgICAgICAgICBzdWNjZXNzTWVzc2FnZS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTtcclxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3NNZXNzYWdlLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpO1xyXG4gICAgICAgICAgICAgIH0sIDMwMDApO1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdSZXZpZXcgaGFzIGJlZW4gc2VudCB0byB0aGUgc2VydmVyIGFuZCByZW1vdmVkIGZyb20gdGhlIEluZGV4ZWREQi4nKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG59KTsiXX0=
